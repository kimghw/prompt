## 1. 기본 원칙
- **작업 지시사항 및 작업 순서를 엄격히 준수**  
- **사용자가 요청한 기능에 대해서만 구현** (과도한 기능 추가 금지)  
- **프로젝트 권한 확인 후 필요시 root 권한으로 실행**  
- **사용자가 요청한 기능은 단일 함수로 구현 하고 테스트**
- **터미널에서 에러가 있으면 완료 후 task를 종료**
- **로그를 기록하여 코드 흐름 분석**

### 1.1 추가 기능 요구 시
- **사용자가 추가 기능 구현을 요구 할 시 기존 프로젝트에 관련된 엔티티, 포트인터페이스, 유즈케이스, 추상활, 상속 관계를 검토 후 기존 코드를 재사용
- ** 프로젝트 아케텍쳐, 요구사항을 분석하고 기존 프로젝트의 엔티티, 비즈니스 로직, 포트/어답터등 기존 코드를 최대한 활용하여 계획 수립 하고 코드 작성
- ** 유사한 기능을 수행하는 엔티티, 유즈시나리오의 함수 호출 흐름도를 파악 하고 최적화된 엔티티, 유즈시나리오로 새로운 단일/복합 유즈시나리오를 구성한다.(항시 호출 흐름 명시 하고 작업할것)
- ** 코드 변경 시 과도하게 길어지지 않게 하고, 길어진느 경우 클래스를 분리 해서 관리(300줄 내외로 작성 권고)
- ** 수정 요청시, 엔티티, 유즈시타리오, 코드 흐름 을 분석 한 후 작업 진행
- ** 확인 및 검증 요청시 readme.md 문서 및 참고자료 확인 후 실행
- ** 유저시나리오에 사용자가 테스트 하거나 요청한 기존/신규 기능의 코드 흐름을 명시 할것 **

### 1.2 API, 라이브러리, 메서드, 필드 신규 사용시
- **deprecated 여부 확인 후 사용
- **API 응답 형식 검증 후 사용
- **Pydantic V2 사용

### 1.3 테스트 시 주의 사항
- **구현과 테스트 간의 계약을 명확히 정의해야 함
- **테스트 작성 시 실제 구현 시그니처와 일치시켜야 함

### 1.4 Task 완료 전 확인 사항
- **메서드 시그니처 불일치 여부 확인
- **API 응답 형식 검증 후 사용
- **모든 비동기 함수는 적절히 await 처리

## 2. 임시 작업 요구 사항(추가사항)
- 프로젝트 진행 중 추가/강조/주의를 주는 내용으로 프로젝트 기간 중 계속 변경

### 2.1. 추가
- **API 테스트는 하지 않는다. CLI 수정하지 않고 유즈케이스. 시나리오 엔티티 등만 수정한다. context 정리할 때 instructions 의 문구를 리마인드
- **사용자가 요청한 기능에 대해서만 구현** (과도한 기능 추가 금지)  

### 2.2. 주의
- ** CLI, DB 조회 시, 참고자료 확인
  
### 2.3 강조
- ** 변경 시, 엔티티나 유즈케이스 확인 후 코드 흐름 분석
- ** 변경 시, 엔티티나 유즈케이스 확인 후 코드 흐름 분석
- ** 변경 시, 엔티티나 유즈케이스 확인 후 코드 흐름 분석



#########  이번 단계 GRAPH API 시나리오 요구사항 입니다. #############

### 4.2 GRAPH API 메일 송수신 조회
## 1. MAIL001 - 특정 사용자 또는 모든 사용자 메일 조회
- 특정 사용자 또는 모든 사용자 GRAPH API 필터를 이용해서 기간별, 최근 N개, 메일 조회
- 특정 사용자 또는 모든 사용자 GRAPH API 필터를 이용해 본문타입(html, txt), 본문, 제목 조회
- 특정 사용자 또는 모든 사용자 GRAPH API 를 이용하여 송신, 수신, 송수신 메일 조회(위 기능 포함)
- 보낸 사용자, 읽은메일/안읽은 메일, 이름등 필터링 후 조회(위 기능 포함)
- 조회 후 데이터베이스 수신 히스토리 분석 후 신규 메일이면 API 엔드포인트로 넘기기
## 2. MAIL002 - 조회 기록 관리
- 이메일 조회 후 메일 제목/송신자/수신자/ID/송수신 시간 등 데이터베이스에 저장
## 3. MAIL003 - 메일 송신
- 메일 보내기
- Authentification flow 에서 인증 링크 메일로 보내기(인증 시 링크 보낼 사람 주소 인자로 넣기)
## 4. MAIL004 - 증분 메일 모니터 및 조회
- delta link 관리
- delta link 초기화 후 링크를 이용해서 갱신된 메일 조회 하고 데이터베이스에 기록이 없으면 API 엔드포인트로 보내기(임베딩 서버 외부 API 제공)
- 웹훅 방식으로 새로운 매일 송수신 시 알람 받기
- 압람 받고 데이터베이스 기록 확인 후 없으면 API 엔드포인트로 보내기
## 5. MAIL005 - 첨부파일 처리 & 오브젝트 스토리지 연동
- 첨부파일 ↔ Graph API /attachments 스트리밍 다운로드
- 크기 > X MB인 대용량은 S3/Blob 등으로 직업업로드 후 URL만 저장
## 6. MAIL006 본문·메타데이터 전처리 & PII 마스킹
- HTML → 텍스트 정규화, 스팸 서명 제거
- 이메일·전화번호·주민번호 등 PII 정규식 마스킹
## 7. MAIL007 외부 API 전송 상태 추적 & 재시도 큐
- API 호출 결과(성공/실패·HTTP Status) 저장
- 실패 건은 지수적 백오프(Exponential Back-off) 재시도
- 3회 이상 실패 시 DLQ(데드 레터 큐) 이동
## 8. MAIL008 이벤트 기반 실시간 푸시(Webhook) ↔ 폴링 대체
- subscription API로 webhook 등록·갱신(Renewal)
- 장애·타임아웃 시 폴링(MAIL001/004)로 자동 전환(Fallback)
## 9. MAIL009 수신 후 사용자 알림(옵션)	
- 특정 조건(키워드, 중요도)에 따라 Slack·Discord·SMS Webhook
- 알림 채널·필터는 사용자·테넌트 설정 테이블화

- ### 4.2 GRAPH API 메일 송수신 조회
## 1. MAIL001 - 특정 사용자 또는 모든 사용자 메일 조회
- 특정 사용자 또는 모든 사용자 GRAPH API 필터를 이용해서 기간별, 최근 N개, 메일 조회
- 특정 사용자 또는 모든 사용자 GRAPH API 필터를 이용해 본문타입(html, txt), 본문, 제목 조회
- 특정 사용자 또는 모든 사용자 GRAPH API 를 이용하여 송신, 수신, 송수신 메일 조회(위 기능 포함)
- 보낸 사용자, 읽은메일/안읽은 메일, 이름등 필터링 후 조회(위 기능 포함)
- 조회 후 데이터베이스 수신 히스토리 분석 후 신규 메일이면 API 엔드포인트로 넘기기
## 2. MAIL002 - 조회 기록 관리
- 이메일 조회 후 메일 제목/송신자/수신자/ID/송수신 시간 등 데이터베이스에 저장
## 3. MAIL003 - 메일 송신
- 메일 보내기
- Authentification flow 에서 인증 링크 메일로 보내기(인증 시 링크 보낼 사람 주소 인자로 넣기)
## 4. MAIL004 - 증분 메일 모니터 및 조회
- delta link 관리
- delta link 초기화 후 링크를 이용해서 갱신된 메일 조회 하고 데이터베이스에 기록이 없으면 API 엔드포인트로 보내기(임베딩 서버 외부 API 제공)
- 웹훅 방식으로 새로운 매일 송수신 시 알람 받기
- 압람 받고 데이터베이스 기록 확인 후 없으면 API 엔드포인트로 보내기
## 5. MAIL005 - 첨부파일 처리 & 오브젝트 스토리지 연동
- 첨부파일 ↔ Graph API /attachments 스트리밍 다운로드
- 크기 > X MB인 대용량은 S3/Blob 등으로 직업업로드 후 URL만 저장
## 6. MAIL006 본문·메타데이터 전처리 & PII 마스킹
- HTML → 텍스트 정규화, 스팸 서명 제거
- 이메일·전화번호·주민번호 등 PII 정규식 마스킹
## 7. MAIL007 외부 API 전송 상태 추적 & 재시도 큐
- API 호출 결과(성공/실패·HTTP Status) 저장
- 실패 건은 지수적 백오프(Exponential Back-off) 재시도
- 3회 이상 실패 시 DLQ(데드 레터 큐) 이동
## 8. MAIL008 이벤트 기반 실시간 푸시(Webhook) ↔ 폴링 대체
- subscription API로 webhook 등록·갱신(Renewal)
- 장애·타임아웃 시 폴링(MAIL001/004)로 자동 전환(Fallback)
## 9. MAIL009 수신 후 사용자 알림(옵션)	
- 특정 조건(키워드, 중요도)에 따라 Slack·Discord·SMS Webhook
- 알림 채널·필터는 사용자·테넌트 설정 테이블화
