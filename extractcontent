## 문서 구조 전처리 프로세스 지침

### 1. 목적

목차 구조가 서로 다른 문서를 **동일한 계층 체계**로 일반화하고,
**비슷한 크기의 세그먼트**(segment)로 분리하여 후속 작업(예 : 임베딩, 검색)에 활용하기 위함입니다.

### 2. 최상위 · 메타 정보

| 필드               | 설명        | 예시                                  |
| ---------------- | --------- | ----------------------------------- |
| `document_id`    | 문서 유형 구분자 | `UR`, `PR`, `ISO`, `지침` …           |
| `document_title` | 문서 전체 제목  | *Unified Requirements Z10.4 Rev.18* |
| `chapter_id`     | 장(章) 구분자  | `Z10`, `Z10.1`, `A11` …             |
| `chapter_title`  | 장 제목      | *Thickness Measurements*            |

---

### 3. 하위 계층 매핑 규칙 
-- 헤더 분석 우선 --

### 3-A. 하위 계층 매핑 규칙 (번호 기반)

| 계층               | 허용 패턴 (정규식 예시)                                          | 비고                                          |
| ---------------- | ------------------------------------------------------- | ------------------------------------------- |
| **section**      | `^(\d+&#124;ANNEX[A-Z]&#124;Table\s+\d+)`               | `1`, `2`, `3` … / `ANNEX A` … / `Table 1` … |
| **sub\_section** | `^\d+\.\d+`  또는  `sheet\s*\d+`                          | `1.1`, `2.3` … / `Sheet 1` …  /'APPENDIX2 |
| **clause**       | `^\d+\.\d+\.\d+`                                        | `1.1.1`, `2.3.4` …                          |
| **item**         | `^\d+\.\d+\.\d+\.\d+`  또는  `^\([a-z]&#124;[ivxlcdm]+\)` | `1.1.1.1`, `(a)`, `(i)` …                   |

> **넘버링 없음** : 헤더(볼드·폰트 크기) 탐지로 위 계층 중 하나에 **임의 매핑**.

---

### 3-A. 번호 없는(스타일 기반) 헤더 매핑 규칙 🔄

| 후보 계층            | 탐지 휴리스틱(스타일 특성)                                                                                 | 상세 기준 · 우선순위 |
| ---------------- | ----------------------------------------------------------------------------------------------- | ------------ |
| **section**      | • **가장 큰 폰트**(본문 대비 ≥ +3 pt)<br>• **볼드 + 올캡스** 예: “GENERAL REQUIREMENTS”<br>• 바로 뒤에 **빈 줄 ≥ 1** | 1순위          |
| **sub\_section** | • **큰 폰트**(본문 대비 ≥ +2 pt)<br>• **볼드**이지만 올캡스는 아님<br>• 상위 section 직후 등장 & 들여쓰기 거의 없음             | —            |
| **clause**       | • **볼드/이탤릭** 혼용<br>• 본문과 **폰트 크기 동일**<br>• **앞뒤로 빈 줄** 존재<br>• 들여쓰기 1단계 수준                      | —            |
| **item**         | • **들여쓰기 2단계 이상** 또는 리스트 기호(●, ■, – 등) 존재                                                       | —            |

**우선 매칭 → 후속 검증** 프로세스

1. 페이지 단위로 **폰트 크기 · 볼드 패턴** 전체 스캔 → `Section > Sub > Clause > Item` 임시 레벨 지정
2. 텍스트 길이 ≤ 60 자 & 마침표(`.`) 미포함 시 헤더 후보 가중치 부여
3. 헤더로 분류되었으나 해당 블록 토큰 수 < 20 이면 본문과 병합해 false-positive 방지

### 4. 세그먼트 분리 규칙

1. **기본** : *Section 1개 → Segment 1개*
2. **750 토큰 초과** 시

   * 두 개 이상 **sub\_section**을 묶어 Segment 구성
   * 필요하면 **clause** / **item** 단위로도 추가 분할
3. **250 토큰 이하** Segment 발생 시

   * **이전 Segment와 병합** (의미적 유사도 고려 권장)

---

### 5. 결과 테이블 필드

| 필드명           | 설명                                   |
| ------------- | ------------------------------------ |
| `document_id` | 최상위 메타                               |
| `chapter_id`  | 장 구분자                                |
| `segment`     | 숫자(ID)                               |
| `section`     | 포함되는 최상위 section 제목                  |
| `포함되는 하위 섹션`  | `sub_section` / `clause` / `item` 목록 |
| `page(s)`     | 시작–끝 페이지                             |
| `예상 토큰*`      | `cl100k_base` 기준 대략값                 |

---

### 6. 작성 예시

#### 6-1. 본문 챕터 예시

| document\_id | chapter\_id | segment | section           | 포함되는 하위 섹션                                    | page(s) | 예상 토큰\* |
| ------------ | ----------- | :-----: | ----------------- | --------------------------------------------- | ------- | ------- |
| UR           | Z10.4       |  **1**  | 1. GENERAL        | 1.1 Application, 1.2 Definitions              | 5–6     | ≈650    |
| UR           | Z10.4       |  **2**  | 1. GENERAL        | 1.3 Repairs, 1.4 Thickness measurements       | 7–11    | ≈600    |
| UR           | Z10.4       |  **3**  | 2. SPECIAL SURVEY | 2.1 Schedule, 2.2 Scope, 2.3 Overall/Close-up | 11–13   | ≈700    |
| UR           | Z10.4       |  **4**  | 2. SPECIAL SURVEY | 2.4 Thickness measurement, 2.5 Tank testing   | 13–15   | ≈550    |

#### 6-2. Annex 예시

| document\_id | chapter\_id | segment | section | 포함되는 하위 섹션                             | page(s) | 예상 토큰\* |
| ------------ | ----------- | :-----: | ------- | -------------------------------------- | ------- | ------- |
| UR           | Z10.4       |  **1**  | ANNEX I | 1. INTRODUCTION                        | 61      | ≈310    |
| UR           | Z10.4       |  **2**  | ANNEX I | 2. PURPOSE AND PRINCIPLES (2.1 \~ 2.4) | 61–62   | ≈620    |
| UR           | Z10.4       |  **3**  | ANNEX I | 3. TECHNICAL ASSESSMENT (3.1)          | 62–63   | ≈420    |

### 7. 지침과 다른 경우
- 지침과 다른 경우 새로운 예시 제시시

> \*토큰 수는 추정치이며 실제 파이프라인 결과와 ± 10 % 차이가 날 수 있습니다.

---


