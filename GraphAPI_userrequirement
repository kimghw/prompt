# Microsoft 365 ë©”ì¼ ìˆ˜ì§‘ ì‹œìŠ¤í…œ v1.0.0

*(created 2025-01-01, last modified 2025-01-01)*

| ì‘ì„±ì  | ì—­í•  | ì´ë©”ì¼                                           |
| :--- | :- | :-------------------------------------------- |
| ì‘ì„±ìëª… | ì—­í•  | [email@example.com](mailto:email@example.com) |

---

## 1. í”„ë¡œì íŠ¸ ê°œìš”

### ğŸ” ë°°ê²½

* Microsoft 365 ì‚¬ìš©ìì˜ ì´ë©”ì¼ ë°ì´í„°ë¥¼ **ì•ˆì „í•˜ê²Œ ìˆ˜ì§‘Â·ë™ê¸°í™”**í•  ì‹œìŠ¤í…œì´ í•„ìš”
* OAuth 2.0 **Authorization Code Flow**ë¡œ ì‚¬ìš©ì ê¶Œí•œì„ ìœ„ì„í•˜ì—¬ ì¸ì¦ ì²˜ë¦¬

### ğŸ¯ ëª©í‘œ

* **Microsoft Graph API**ë¥¼ ì´ìš©í•œ ì•ˆì „í•œ ë©”ì¼ ë°ì´í„° ìˆ˜ì§‘
* ë‹¤ìˆ˜ ì‚¬ìš©ì ì´ë©”ì¼ ê³„ì • ë° ì„¤ì •íŒŒì¼ ê´€ë¦¬
* ë‹¤ìˆ˜ ì‚¬ìš©ì ìœ„ì„, ë©”ì¼ ì¡°íšŒ, ë©”ì¼ ë³´ë‚´ê¸° 
* ê°±ì‹ ëœ ì´ë©”ì¼ ì¡°íšŒ ë° ì•Œë¦¼ ìˆ˜ì‹ ìœ¼ë¡œ ì¦ë¶„ ë°ì APIë¡œ ì†¡ì‹ 
* 

### ğŸ’ í•µì‹¬ ê°€ì¹˜

| ê°€ì¹˜          | ì„¤ëª…                              |
| :----------   |  :------------------------------ |
| **ë³´ì•ˆì„±**     | OAuth 2.0 ê¸°ë°˜ ì•ˆì „í•œ ì¸ì¦Â·ê¶Œí•œ ê´€ë¦¬       |
| **íš¨ìœ¨ì„±**     | Delta Query í™œìš© ì¦ë¶„ ë™ê¸°í™”, ë©”ì¼ ìˆ˜ì‹  ì•Œë¦¼ |
| **ì‚¬ìš©ì ì¹œí™”ì„±** | ê°„í¸í•œ ì›¹ ê¸°ë°˜ ì¸ì¦ í”„ë¡œì„¸ìŠ¤                |

### ğŸ‘¥ ëŒ€ìƒ ì‚¬ìš©ì

| ìœ í˜•      | í•„ìš” ì‚¬í•­                    |
| :------ | :----------------------- |
| ê¸°ì—… ì‚¬ìš©ì  | Microsoft 365 ê³„ì •, ì›¹ ë¸Œë¼ìš°ì € |
| ì‹œìŠ¤í…œ ê´€ë¦¬ì | ì‚¬ìš©ì ê¶Œí•œ ê´€ë¦¬, ë™ê¸°í™” ìƒíƒœ ëª¨ë‹ˆí„°ë§   |

---

## 2. í”„ë¡œì íŠ¸ ë²”ìœ„

### í¬í•¨

* ë‹¤ì¤‘ ì‚¬ìš©ì ê³„ì • ë° ì„¤ì •íŒŒì¼ ê´€ë¦¬
* OAuth 2.0 ì¸ì¦ ë° í† í° ê´€ë¦¬
* Microsoft Graph APIë¥¼ í†µí•œ ë©”ì¼ ì¡°íšŒ, ë³´ë‚´ê¸°
* ì¦ë¶„ ë©”ì¼ ì¸ì§€ ë° ë™ê¸°í™”(ë¸íŠ¸ë§í¬, ì›¹í›…)
* ìˆ˜ì§‘ ë©”ì¼ ì €ì¥Â·ê´€ë¦¬ & ê¸°ê°„ë³„ ë©”ì¼ ìˆ˜ì§‘
* ë°ì´í„°ë² ì´ìŠ¤ë¡œ ê³„ì • ë° ì¡°íšŒí•œ ë©”ì¼ íˆìŠ¤í† ë¦¬ ê´€ë¦¬ 

---

## 3. ê¸°ìˆ  ìŠ¤íƒ

## 3. ê¸°ìˆ  ìŠ¤íƒ â€• **ì „ì²´ í†µí•©í‘œ**

| êµ¬ë¶„                    | íŒ¨í‚¤ì§€ / ì—”ì§„             | ë²„ì „                  | ìš©ë„ Â· ë¹„ê³                           |
| :--------------------  | :------------------- | :------------------ | :------------------------------- |
| **ì–¸ì–´ & ëŸ°íƒ€ì„**        | Python               | **3.11 ê¶Œì¥** (3.10+) | ë¹„ë™ê¸° ì§€ì›, MSAL í˜¸í™˜                  |
| **ì›¹ Â· ASGI**          | FastAPI              | 0.104.1             | REST API ì„œë²„, OAuth ì½œë°±            |
|                        | Uvicorn              | 0.24.0              | ASGI ì‹¤í–‰ ì„œë²„                       |
| **CLI**                | Typer                | 0.9.0               | í˜„ëŒ€ì  CLI í”„ë ˆì„ì›Œí¬                    |
|                       | Rich                 | 13.7.0              | í„°ë¯¸ë„ UI (ì»¬ëŸ¬, í‘œ, í”„ë¡œê·¸ë ˆìŠ¤ë°”)           |
| **ë°ì´í„° ê²€ì¦ & ì„¤ì •**    | Pydantic             | 2.5.0               | ë°ì´í„° ê²€ì¦Â·ì§ë ¬í™”                       |
|                       | Pydantic-Settings    | 2.1.0               | ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì • ê²€ì¦ (.env í¬í•¨)           |
|                       | Python-dotenv        | 1.0.0               | `.env` íŒŒì¼ ë¡œë”©                     |
| **HTTP í´ë¼ì´ì–¸íŠ¸**      | HTTPX                | 0.25.2              | ë¹„ë™ê¸° HTTP í˜¸ì¶œ                      |
|                       | Requests             | 2.31.0              | ë™ê¸° HTTP (í˜¸í™˜ìš©)                    |
|                       | aiohttp              | latest              | OAuth ì½œë°± ì„œë²„ ë“± ë³´ì¡°                 |
| **ORM Â· DB Â· ë§ˆì´ê·¸ë ˆì´ì…˜** | SQLAlchemy           | 2.0.23              | ë¹„ë™ê¸° ORM                          |
|                       | Alembic              | 1.13.1              | DB ë§ˆì´ê·¸ë ˆì´ì…˜                        |
|                       | PostgreSQL           | latest              | í”„ë¡œë•ì…˜ ë©”ì¸ DB                       |
|                       | SQLite               | â€”                   | ê°œë°œÂ·í…ŒìŠ¤íŠ¸ìš© ê²½ëŸ‰ DB                    |
| **ìºì‹œ / ë¸Œë¡œì»¤**        | Redis                | 5.0.1               | ìºì‹±Â·ë©”ì‹œì§€ ë¸Œë¡œì»¤ *(Celery backend)*    |
| **ë¹„ë™ê¸° & ë°±ê·¸ë¼ìš´ë“œ**   | asyncio              | builtin             | Python í‘œì¤€ ë¹„ë™ê¸° ëŸ¬ë„ˆ                 |
|                       | aiofiles             | 23.2.1              | ë¹„ë™ê¸° íŒŒì¼ I/O                       |
|                       | Celery               | 5.3.4               | ë¶„ì‚° ì‘ì—… í *(ì„ íƒ)*                   |
| **ì¬ì‹œë„ Â· ë³µì›ë ¥**      | tenacity             | 9.1.2               | ì¬ì‹œë„Â·ë°±ì˜¤í”„ íŒ¨í„´                       |
| **ì¸ì¦ Â· ë³´ì•ˆ**         | MSAL                 | 1.25.0              | Microsoft Authentication Library |
|                       | Authlib              | latest              | OAuth 2.0 êµ¬í˜„ ë³´ì¡°                  |
|                       | python-jose          | latest              | JWT ì„œëª…Â·ê²€ì¦                        |
|                       | Custom OAuth Impl.   | â€”                   | Authorization Code + PKCE ë¡œì§     |
| **ë¡œê¹… Â· ëª¨ë‹ˆí„°ë§**         | structlog            | 23.2.0              | êµ¬ì¡°í™”ëœ(í‚¤-ê°’) ë¡œê¹…                     |
|                       | python-json-logger   | 2.0.7               | JSON í¬ë§·í„°                         |
|                       | sentry-sdk\[fastapi] | 1.38.0              | ì—ëŸ¬Â·ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ *(ì„ íƒ)*                |
| **ì½”ë“œ í’ˆì§ˆ**             | black                | 23.11.0             | ì½”ë“œ í¬ë§¤í„°                           |
|                       | isort                | 5.12.0              | import ì •ë ¬                        |
| **í…ŒìŠ¤íŒ…**               | pytest               | 7.4.3               | í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬                        |
|                       | pytest-asyncio       | 0.21.1              | ë¹„ë™ê¸° í…ŒìŠ¤íŠ¸ ì§€ì›                       |
|                       | pytest-cov           | 4.1.0               | ì»¤ë²„ë¦¬ì§€ ì¸¡ì •                          |
| **ìœ í‹¸ë¦¬í‹°**            | python-dateutil      | 2.8.2               | ê³ ê¸‰ ë‚ ì§œÂ·ì‹œê°„ ì²˜ë¦¬                      |
| **ê°œë°œ ë„êµ¬**           | VS Code              | â€”                   | ê¶Œì¥ IDE                           |
|                       | Git                  | â€”                   | ë²„ì „ ê´€ë¦¬                            |
|                       | Docker               | latest              | ì»¨í…Œì´ë„ˆí™” *(ì„ íƒ)*                     |
| **í™˜ê²½ ê´€ë¦¬**            | venv / conda         | â€”                   | ê°€ìƒí™˜ê²½                             |
|                       | .env config          | â€”                   | í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬ (.env)                  |




## 4. ìœ ì¦ˆ ì‹œë‚˜ë¦¬ì˜¤
### 4.1 GRAPH API ë‹¤ì¤‘ ê³„ì • ë° ì¸ì¦ ê´€ë¦¬
1. AUTH001 - ê³„ì • ë“±ë¡(ê¸°ë³¸ : ê¶Œí•œìœ„ì„)
- Authorization Code Flow ì™€ Devide code flow ì¤‘ ì¸ì¦ë°©ì‹ ì„ íƒ í›„ í•„ìˆ˜ ì •ë³´ ì…ë ¥í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
- ë‘ ë°©ì‹ì— ê³µí†µëœ í…Œì´ë¸” A ë¥¼ ë‘ê³  ê°ê° B, C í…Œì´ë¸”ì„ êµ¬ì„±
2. AUTH002 - ID ë˜ëŠ” ì´ë©”ì¼ ì •ë³´ë¡œ ì¡°íšŒ/ë³€ê²½/ì‚­ì œ
- ID ë˜ëŠ” ì´ë©”ì¼ ì •ë³´ë¡œ ì¡°íšŒ/ë³€ê²½/ì‚­ì œ
- ëª¨ë“  ì‚¬ìš©ì ì •ë³´ ìƒì„¸ ë³´ê¸°
- ì‚¬ìš©ì íŠ¹ì • ì •ë³´ ê²€ìƒ‰
- ì‚¬ìš©ì ë˜ëŠ” ëª¨ë“  ì‚¬ìš©ì í† í° ìƒíƒœ ì •ë³´ ë³´ê¸°
3. AUTH003 - ì¸ì¦í•˜ê¸°
- ì‚¬ìš©ìì •ë³´(ì´ë©”ì¼/ID)ì™€ ì¸ì¦ê³¼ì •(Authentification flow, device flow)ì— ë”°ë¼ ì¸ì¦í•˜ê¸°, ì¸ì¦ì‹œ í•„ìš”í•œ ì •ë³´ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ê°–ì–´ì™€ì„œ í˜¸ì¶œí•˜ê¸°
- Authentification flow ì—ì„œ ë¡œê·¸ì¸ í˜ì´ì ì‚¬ìš©ìì—ê²Œ ë³´ë‚´ê¸°(ê¶Œí•œìœ„ì„ ê³¼ì •)
- íŠ¹ì • ì‚¬ìš©ì ë˜ëŠ” ëª¨ë“  ì‚¬ìš©ì ì¸ì¦ í•˜ê¸° 
- ì¸ì¦ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì½”ë“œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
- ì¸ì¦ ì„±ê³µ ì‹œ í† í¬ ì €ì¥(í† í° ê´€ë ¨ í…Œì´ë¸” ìƒì„± í›„ ì €ì¥)
4. AUTH004 - í† í° ê°±ì‹ 
- ì‚¬ìš©ìë³„ í† í° ìƒíƒœ ê´€ë¦¬
- í† í° ìœ íš¨ì„± ê²€ì‚¬ ë° ìë™ ê°±ì‹  ì„¤ì •
5. AUTH005 - ê¶Œí•œ/ë™ì˜ ë²”ìœ„ ì ê²€ ë° ì¬ìš”ì²­
- í˜„ì¬ ì €ì¥ëœ ìŠ¤ì½”í”„ì™€ ì‹¤ì œ í•„ìš”í•œ ìŠ¤ì½”í”„ diff- ë¶€ì¡±ì‹œ ì‚¬ìš©ì ë™ì˜ í™”ë©´ ì¬ ë…¸ì¶œ
6. AUTH006 - ì•¡ì„¸ìŠ¤/ë¦¬í”„ë ˆì‹œ í† í° íê¸°
- íŠ¹ì • ì‚¬ìš©ì ë˜ëŠ” ì „ì²´ ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ
- í† í° ìºì‹œ ë¬´íš¨í™” ë° Graph API revokeSignSessions í˜¸ì¶œ
7. AUTH007 - ì¸ì¦.í† í° ë¡œê·¸ ì¡°íšŒ API
- AUTH001-004 ì „ ê³¼ì •ì„ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼/DBì— ì €ì¥
- ê¸°ê°„, ì‚¬ìš©ì ê²°ê³¼(ì„±ê³µ/ì‹ª0) ê¸°ì¤€ í•„í„°/ë‹¤ìš´ë¡œë“œ

### 4.2 GRAPH API ë©”ì¼ ì†¡ìˆ˜ì‹  ì¡°íšŒ
## 1. MAIL001 - íŠ¹ì • ì‚¬ìš©ì ë˜ëŠ” ëª¨ë“  ì‚¬ìš©ì ë©”ì¼ ì¡°íšŒ
- íŠ¹ì • ì‚¬ìš©ì ë˜ëŠ” ëª¨ë“  ì‚¬ìš©ì GRAPH API í•„í„°ë¥¼ ì´ìš©í•´ì„œ ê¸°ê°„ë³„, ìµœê·¼ Nê°œ, ë©”ì¼ ì¡°íšŒ
- íŠ¹ì • ì‚¬ìš©ì ë˜ëŠ” ëª¨ë“  ì‚¬ìš©ì GRAPH API í•„í„°ë¥¼ ì´ìš©í•´ ë³¸ë¬¸íƒ€ì…(html, txt), ë³¸ë¬¸, ì œëª© ì¡°íšŒ
- íŠ¹ì • ì‚¬ìš©ì ë˜ëŠ” ëª¨ë“  ì‚¬ìš©ì GRAPH API ë¥¼ ì´ìš©í•˜ì—¬ ì†¡ì‹ , ìˆ˜ì‹ , ì†¡ìˆ˜ì‹  ë©”ì¼ ì¡°íšŒ(ìœ„ ê¸°ëŠ¥ í¬í•¨)
- ë³´ë‚¸ ì‚¬ìš©ì, ì½ì€ë©”ì¼/ì•ˆì½ì€ ë©”ì¼, ì´ë¦„ë“± í•„í„°ë§ í›„ ì¡°íšŒ(ìœ„ ê¸°ëŠ¥ í¬í•¨)
- ì¡°íšŒ í›„ ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì‹  íˆìŠ¤í† ë¦¬ ë¶„ì„ í›„ ì‹ ê·œ ë©”ì¼ì´ë©´ API ì—”ë“œí¬ì¸íŠ¸ë¡œ ë„˜ê¸°ê¸°
## 2. MAIL002 - ì¡°íšŒ ê¸°ë¡ ê´€ë¦¬
- ì´ë©”ì¼ ì¡°íšŒ í›„ ë©”ì¼ ì œëª©/ì†¡ì‹ ì/ìˆ˜ì‹ ì/ID/ì†¡ìˆ˜ì‹  ì‹œê°„ ë“± ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
## 3. MAIL003 - ë©”ì¼ ì†¡ì‹ 
- ë©”ì¼ ë³´ë‚´ê¸°
- Authentification flow ì—ì„œ ì¸ì¦ ë§í¬ ë©”ì¼ë¡œ ë³´ë‚´ê¸°(ì¸ì¦ ì‹œ ë§í¬ ë³´ë‚¼ ì‚¬ëŒ ì£¼ì†Œ ì¸ìë¡œ ë„£ê¸°)
## 4. MAIL004 - ì¦ë¶„ ë©”ì¼ ëª¨ë‹ˆí„° ë° ì¡°íšŒ
- delta link ê´€ë¦¬
- delta link ì´ˆê¸°í™” í›„ ë§í¬ë¥¼ ì´ìš©í•´ì„œ ê°±ì‹ ëœ ë©”ì¼ ì¡°íšŒ í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì— ê¸°ë¡ì´ ì—†ìœ¼ë©´ API ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³´ë‚´ê¸°(ì„ë² ë”© ì„œë²„ ì™¸ë¶€ API ì œê³µ)
- ì›¹í›… ë°©ì‹ìœ¼ë¡œ ìƒˆë¡œìš´ ë§¤ì¼ ì†¡ìˆ˜ì‹  ì‹œ ì•ŒëŒ ë°›ê¸°
- ì••ëŒ ë°›ê³  ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë¡ í™•ì¸ í›„ ì—†ìœ¼ë©´ API ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³´ë‚´ê¸°
## 5. MAIL005 - ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬ & ì˜¤ë¸Œì íŠ¸ ìŠ¤í† ë¦¬ì§€ ì—°ë™
- ì²¨ë¶€íŒŒì¼ â†” Graph API /attachments ìŠ¤íŠ¸ë¦¬ë° ë‹¤ìš´ë¡œë“œ
- í¬ê¸° > X MBì¸ ëŒ€ìš©ëŸ‰ì€ S3/Blob ë“±ìœ¼ë¡œ ì§ì—…ì—…ë¡œë“œ í›„ URLë§Œ ì €ì¥
## 6. MAIL006 ë³¸ë¬¸Â·ë©”íƒ€ë°ì´í„° ì „ì²˜ë¦¬ & PII ë§ˆìŠ¤í‚¹
- HTML â†’ í…ìŠ¤íŠ¸ ì •ê·œí™”, ìŠ¤íŒ¸ ì„œëª… ì œê±°
- ì´ë©”ì¼Â·ì „í™”ë²ˆí˜¸Â·ì£¼ë¯¼ë²ˆí˜¸ ë“± PII ì •ê·œì‹ ë§ˆìŠ¤í‚¹
## 7. MAIL007 ì™¸ë¶€ API ì „ì†¡ ìƒíƒœ ì¶”ì  & ì¬ì‹œë„ í
- API í˜¸ì¶œ ê²°ê³¼(ì„±ê³µ/ì‹¤íŒ¨Â·HTTP Status) ì €ì¥
- ì‹¤íŒ¨ ê±´ì€ ì§€ìˆ˜ì  ë°±ì˜¤í”„(Exponential Back-off) ì¬ì‹œë„
- 3íšŒ ì´ìƒ ì‹¤íŒ¨ ì‹œ DLQ(ë°ë“œ ë ˆí„° í) ì´ë™
## 8. MAIL008 ì´ë²¤íŠ¸ ê¸°ë°˜ ì‹¤ì‹œê°„ í‘¸ì‹œ(Webhook) â†” í´ë§ ëŒ€ì²´
- subscription APIë¡œ webhook ë“±ë¡Â·ê°±ì‹ (Renewal)
- ì¥ì• Â·íƒ€ì„ì•„ì›ƒ ì‹œ í´ë§(MAIL001/004)ë¡œ ìë™ ì „í™˜(Fallback)
## 9. MAIL009 ìˆ˜ì‹  í›„ ì‚¬ìš©ì ì•Œë¦¼(ì˜µì…˜)	
- íŠ¹ì • ì¡°ê±´(í‚¤ì›Œë“œ, ì¤‘ìš”ë„)ì— ë”°ë¼ SlackÂ·DiscordÂ·SMS Webhook
- ì•Œë¦¼ ì±„ë„Â·í•„í„°ëŠ” ì‚¬ìš©ìÂ·í…Œë„ŒíŠ¸ ì„¤ì • í…Œì´ë¸”í™”





1. 

ì¸ ê²½ìš° í•„ìˆ˜ ê°’ ì…ë ¥í•œ í›„ ê³„ì • ìƒì„± í›„ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
- Devide code flow ì¸ ê²½ìš° í•„ìˆ˜ ê°’ ì…ë ¥í•œ í›„ ê²Œì • ìƒì„± í›„ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥

| ID          | ê¸°ëŠ¥             |   ì£¼ìš” ì²˜ë¦¬ ë‹¨ê³„                                                                         | ì…ë ¥ DTO                     | ì¶œë ¥ DTO      | ë¹„ê³                                                        |
| :---------- | :----------     | :-----------------------------------------------------------------------------------  | :-------------------------- | :----------- | :-------------------------------------------------------------------- |
| **ACCU001** | ê³„ì •(í…Œë„ŒíŠ¸) ë“±ë¡   | 1) EmailÂ·Tenant ID ì¤‘ë³µ í™•ì¸ â†’ 2) DB ì €ì¥ â†’ 3) ê°ì‚¬ ë¡œê·¸                                  | `CreateAccountRequest` ,            | `AccountDTO` | â€¢ ì‚¬ìš©ìë¡œ ë¶€í„° ê³„ì •ì •ë³´ë¥¼ ë°›ì•„ 
| **ACCU002** | ê³„ì • ì¡°íšŒ/ë³€ê²½/ì‚­ì œ | 1) ID ì¡´ì¬ í™•ì¸ â†’ 2) ê¶Œí•œ ê²€ì‚¬ â†’ 3) ì½ê¸°Â·ê°±ì‹ Â·Soft-delete â†’ 4) ê°ì‚¬ ë¡œê·¸                     | `AccountId`â€†/â€†`QueryParams`   | `AccountDTO` | â€¢ Soft-delete (`deleted_at`) <br>â€¢ Status ë³€ê²½ ì‹œ í† í° ì¬ê²€ì¦                 |

# ì…ë ¥
class CreateAccountRequest(BaseModel):
    email: EmailStr
    tenant_id: str
    auth_type: Literal["delegated"] = "delegated"
    refresh_token: SecretStr

class UpdateAccountRequest(BaseModel):
    status: Literal["active", "inactive", "error"] | None = None
    sync_window_days: int | None = None
    folder_filters: list[str] | None = None

# ì¶œë ¥
class TokenMeta(BaseModel):
    issued_at: datetime
    expires_at: datetime
    expires_in: int

class AccountDTO(BaseModel):
    account_id: UUID
    email: EmailStr
    tenant_id: str
    status: str
    created_at: datetime
    last_sync_at: datetime | None
    token: TokenMeta | None        # ë©”íƒ€ë§Œ! (raw JWT X)

class DeleteResult(BaseModel):
    deleted: bool
    account_id: UUID

class PaginatedAccounts(BaseModel):
    total: int
    page: int
    size: int
    items: list[AccountDTO]


| **ACCU003** | í† í° ìƒíƒœ í™•ì¸         | ìœ íš¨ì„±Â·ê¶Œí•œÂ·ë§Œë£Œ ì‹œì  ì ê²€                         | ë¯¸êµ¬í˜„ |
### 4.1 ì¸ì¦(Authentication)

| ID          | ê¸°ëŠ¥               | ì„¤ëª…                                      | ìƒíƒœ  |
| :---------- | :--------------- | :-------------------------------------- | :-- |
| **AUTH001** | OAuth 2.0 ì‚¬ìš©ì ì¸ì¦ | Authorization Code Flow, PKCEÂ·state í¬í•¨  | ê°œë°œì¤‘ |
| **AUTH002** | í† í° ê°±ì‹             | ë§Œë£Œëœ Access Tokenì„ Refresh Tokenìœ¼ë¡œ ìë™ ê°±ì‹  | ê°œë°œì¤‘ |
| **AUTH004** | í† í° ìƒíƒœ í™•ì¸         | ìœ íš¨ì„±Â·ê¶Œí•œÂ·ë§Œë£Œ ì‹œì  ì ê²€                         | ë¯¸êµ¬í˜„ |

**AUTH001 ì²˜ë¦¬ íë¦„**

1. ì¸ì¦ URL ìƒì„±(state, PKCE)
2. ì‚¬ìš©ìë¥¼ Microsoft ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
3. `authorization_code` ìˆ˜ì‹  â†’ Access Token êµí™˜
4. Refresh Token ì•ˆì „ ì €ì¥

ì¶œë ¥(JSON ì˜ˆì‹œ):

```json
{
  "access_token": "...",
  "refresh_token": "...",
  "expires_in": 3600,
  "user_info": {
    "email": "user@example.com",
    "display_name": "í™ê¸¸ë™"
  }
}
```

---

### 4.2 ë©”ì¼ ìˆ˜ì§‘(Mail Collection)

| ID          | ê¸°ëŠ¥         | Graph API ì—”ë“œí¬ì¸íŠ¸                            | ìš°ì„ ìˆœìœ„ | ìƒíƒœ  |
| :---------- | :--------- | :----------------------------------------- | :--- | :-- |
| **MAIL001** | ë©”ì¼ ëª©ë¡ ìˆ˜ì§‘   | `GET /me/messages`                         | í•„ìˆ˜   | ê°œë°œì¤‘ |
| **MAIL002** | í´ë”ë³„ ë©”ì¼ ìˆ˜ì§‘  | `GET /me/mailFolders/{folder-id}/messages` | ì¤‘ìš”   | ë¯¸êµ¬í˜„ |
| **MAIL003** | **ì¦ë¶„ ë™ê¸°í™”** | `GET /me/messages/delta`                   | í•„ìˆ˜   | ë¯¸êµ¬í˜„ |
| **MAIL004** | ê¸°ê°„ ë©”ì¼ ìˆ˜ì§‘   | `GET /me/messages` (ì¿¼ë¦¬)                    | í•„ìˆ˜   | ê°œë°œì¤‘ |
| **MAIL005** | ìƒˆë¡œìš´ ë©”ì¼ ì•Œë¦¼  | (Webhooks / Subscriptions)                 | í•„ìˆ˜   | ë¯¸êµ¬í˜„ |

*MAIL003 ì¦ë¶„ ë™ê¸°í™” ë‹¨ê³„*

1. ìµœì´ˆ ì „ì²´ ë™ê¸°í™” â†’ `deltaLink` ì €ì¥
2. ì´í›„ ë™ê¸°í™” ì‹œ `deltaLink` ì‚¬ìš© â†’ ë³€ê²½ë¶„ë§Œ ìˆ˜ì§‘
3. ìµœì‹  `deltaLink`ë¡œ ê°±ì‹ 

---

## 5. ë¹„ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­

### ğŸ” ë³´ì•ˆ

* PKCEÂ·state íŒŒë¼ë¯¸í„°, HTTPS ì „ìš©
* Access Token 1 ì‹œê°„Â·Refresh Token 90 ì¼
* ë§Œë£Œ 5 ë¶„ ì „ ìë™ ê°±ì‹ 
* ìµœì†Œ ê¶Œí•œ ì›ì¹™(í•„ìš” ìŠ¤ì½”í”„ë§Œ ìš”ì²­)

### ğŸš€ ì„±ëŠ¥

* ë™ì‹œ ì¸ì¦ ì²˜ë¦¬ : 100 ì‚¬ìš©ì/ë¶„
* ë©”ì¼ ìˆ˜ì§‘ ì†ë„ : 1 000 ë©”ì¼/ë¶„
* í† í° ê°±ì‹  < 1 ì´ˆ

### â˜‘ï¸ ê°€ìš©ì„±

* í† í° ê°±ì‹  ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„
* Graph API ì¥ì•  ì‹œ ì§€ìˆ˜ ë°±ì˜¤í”„
* ë¡œì»¬ ìºì‹±ìœ¼ë¡œ ì¼ì‹œì  ì˜¤í”„ë¼ì¸ ì§€ì›

---

## 6. API ì—”ë“œí¬ì¸íŠ¸ ì„¤ê³„

### ğŸ”‘ Authentication

| Method   | Path                          | ì„¤ëª…                       |
| :------- | :---------------------------- | :----------------------- |
| **GET**  | `/auth/login`                 | Microsoft ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ |
| **GET**  | `/auth/callback?code=&state=` | OAuth ì½œë°±, í† í° êµí™˜          |
| **POST** | `/auth/refresh`               | í† í° ê°±ì‹                     |
| **POST** | `/auth/logout`                | ë¡œê·¸ì•„ì›ƒ                     |
| **GET**  | `/auth/status`                | í˜„ì¬ ì¸ì¦ ìƒíƒœ ì¡°íšŒ              |

### âœ‰ï¸ Mail Operations

| Method   | Path             | ì„¤ëª…           |
| :------- | :--------------- | :----------- |
| **POST** | `/mail/sync`     | ë©”ì¼ ë™ê¸°í™” ì‹œì‘    |
| **GET**  | `/mail/folders`  | ë©”ì¼ í´ë” ëª©ë¡ ì¡°íšŒ  |
| **GET**  | `/mail/messages` | ìˆ˜ì§‘ëœ ë©”ì¼ ëª©ë¡ ì¡°íšŒ |

---

## 7. ë°ì´í„° ëª¨ë¸

### 7.1 `user_session`

| í•„ë“œ                 | íƒ€ì… / ì œì•½              |
| :----------------- | :------------------- |
| `user_id`          | string PK            |
| `email`            | string               |
| `display_name`     | string               |
| `access_token`     | **encrypted** string |
| `refresh_token`    | **encrypted** string |
| `token_expires_at` | datetime             |
| `delta_link`       | string               |
| `last_sync`        | datetime             |

### 7.2 `mail_message`

| í•„ë“œ                  | íƒ€ì… / ì œì•½   |
| :------------------ | :-------- |
| `message_id`        | string PK |
| `user_id`           | string FK |
| `subject`           | string    |
| `from_address`      | string    |
| `to_addresses`      | array     |
| `received_datetime` | datetime  |
| `folder_id`         | string    |
| `is_read`           | boolean   |
| `has_attachments`   | boolean   |

---

## 8. ì—ëŸ¬ ì²˜ë¦¬

### Authentication

| ì½”ë“œ              | ì„¤ëª…    | ì¡°ì¹˜             |
| :-------------- | :---- | :------------- |
| `AUTH_FAILED`   | ì¸ì¦ ì‹¤íŒ¨ | ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ |
| `TOKEN_EXPIRED` | í† í° ë§Œë£Œ | ìë™ ê°±ì‹  ì‹œë„       |
| `INVALID_SCOPE` | ê¶Œí•œ ë¶€ì¡± | ì¶”ê°€ ê¶Œí•œ ìš”ì²­       |

### API

| ì½”ë“œ                | ì„¤ëª…           | ì¡°ì¹˜           |
| :---------------- | :----------- | :----------- |
| `RATE_LIMIT`      | í˜¸ì¶œ í•œë„ ì´ˆê³¼     | ì§€ìˆ˜ ë°±ì˜¤í”„ë¡œ ì¬ì‹œë„  |
| `GRAPH_API_ERROR` | Graph API ì˜¤ë¥˜ | ì—ëŸ¬ ë¡œê¹…Â·ì‚¬ìš©ì ì•Œë¦¼ |

---

## 9. ëª¨ë‹ˆí„°ë§

### ğŸ“Š ì£¼ìš” ì§€í‘œ

* ì¸ì¦ ì„±ê³µ/ì‹¤íŒ¨ìœ¨
* í† í° ê°±ì‹  ë¹ˆë„
* API í˜¸ì¶œ ìˆ˜/ë¶„
* ë™ê¸°í™”ëœ ë©”ì¼ ìˆ˜
* í‰ê·  ì‘ë‹µ ì‹œê°„

### ğŸ”” ì•Œë¦¼ ì¡°ê±´

* ì¸ì¦ ì‹¤íŒ¨ìœ¨ > 10 %
* í† í° ê°±ì‹  ì‹¤íŒ¨ ë°œìƒ
* API í• ë‹¹ëŸ‰ 80 % ì´ˆê³¼
* ë™ê¸°í™” ì§€ì—° > 5 ë¶„

---

> **ì´ ë¬¸ì„œëŠ” YAML ìš”êµ¬ì‚¬í•­ì„ Markdown í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•œ ë²„ì „ì…ë‹ˆë‹¤.** í•„ìš”ì— ë”°ë¼ ì„¹ì…˜ì„ ì¶”ê°€Â·ìˆ˜ì •í•´ ì‚¬ìš©í•˜ì„¸ìš”.
