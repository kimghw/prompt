# 사용자 요구사항 문서 (YAML)
# Microsoft Graph API 메일 수집 시스템

project:
  name: "Microsoft 365 메일 수집 시스템"
  version: "1.0.0"
  created_date: "2024-01-01"
  last_modified: "2024-01-01"
  authors:
    - name: "작성자명"
      role: "역할"
      email: "email@example.com"

# 1. 프로젝트 개요
overview:
  background: |
    Microsoft 365 사용자의 이메일 데이터를 안전하게 수집하고 동기화하는 시스템 필요
    OAuth 2.0 Authorization Code Flow를 통한 사용자 권한 위임 방식 적용
  
  objectives:
    - "Microsoft Graph API를 통한 안전한 메일 데이터 수집"
    - "사용자별 권한 위임 기반 인증 구현"
    - "증분 동기화를 통한 효율적인 데이터 관리"
  
  core_values:
    - value: "보안성"
      description: "OAuth 2.0 기반 안전한 인증 및 권한 관리"
    - value: "효율성"
      description: "Delta Query를 활용한 증분 동기화", "메일 수신 시 알림'
    - value: "사용자 친화성"
      description: "간편한 웹 기반 인증 프로세스"
  
  target_users:
    - type: "기업 사용자"
      needs: ["Microsoft 365 계정", "웹 브라우저"]
    - type: "시스템 관리자"
      needs: ["사용자 권한 관리", "동기화 상태 모니터링"]

# 2. 프로젝트 범위
scope:
  included:
    - "OAuth 2.0 Authorization Code Flow 인증 시스템"
    - "권한위임 방식"
    - "Microsoft Graph API를 통한 메일 수집"
    - "토큰 관리 및 자동 갱신"
    - "증분 동기화 (Delta Query)"
    - "수집된 메일 데이터 저장 및 관리"
    - "특정 기간 동안 송수신 메일 수집 및 관리"
    - "메일 작성 및 발송 기능"
    - "첨부파일 분석"
    - "메일 내용 검색 엔진"

# 3. 기술 스택
technology_stack:
  languages:
    - name: "Python"
      version: "3.10+"
      reason: "MSAL 라이브러리 지원, 비동기 처리"
  
  frameworks:
    backend:
      - name: "FastAPI"
        version: "0.104.1"
        purpose: "REST API 서버 및 OAuth 콜백 처리"
    
  databases:
    primary:
      type: "PostgreSQL"
      version: "15.0"
      purpose: "메일 메타데이터 및 토큰 저장"
    cache:
      type: "Redis"
      version: "7.0"
      purpose: "토큰 캐싱 및 세션 관리"
  
  authentication_libraries:
    - name: "MSAL (Microsoft Authentication Library)"
      version: "1.24+"
      purpose: "Microsoft 인증 처리"
    - name: "Authlib"
      version: "1.2+"
      purpose: "OAuth 2.0 플로우 구현"

# 4. 기능 요구사항
functional_requirements:
  authentication_features:
    - id: "AUTH001"
      name: "OAuth 2.0 사용자 인증"
      description: "Authorization Code Flow를 통한 Microsoft 365 사용자 인증, 권한위임 방식"
      priority: "필수"
      status: "개발중"
      processing_steps:
        - "인증 URL 생성 (state, PKCE 포함)"
        - "사용자를 Microsoft 로그인 페이지로 리다이렉트"
        - "Authorization Code 수신"
        - "Code를 Access Token으로 교환"
        - "Refresh Token 안전하게 저장"
      input:
        - type: "OAuth Parameters"
          fields:
            - name: "client_id"
              type: "string"
            - name: "client_secret"
              type: "string"
            - name: "redirect_uri"
              type: "string"
            - name: "scope"
              type: "string"
              default: "User.Read Mail.Read Mail.ReadWrite offline_access"
      output:
        - type: "JSON"
          schema:
            access_token: "string"
            refresh_token: "string"
            expires_in: "integer"
            user_info:
              email: "string"
              display_name: "string"
    
    - id: "AUTH002"
      name: "토큰 갱신"
      description: "만료된 Access Token을 Refresh Token으로 자동 갱신"
      priority: "필수"
      status: "개발중"
      processing_steps:
        - "토큰 만료 시간 확인"
        - "Refresh Token으로 새 Access Token 요청"
        - "새 토큰 저장 및 캐시 업데이트"
      
    - id: "AUTH003"
      name: "로그아웃"
      description: "사용자 세션 종료 및 토큰 폐기"
      priority: "필수"
      status: "미구현"
      processing_steps:
        - "로컬 토큰 삭제"
        - "Redis 세션 정리"
        - "Microsoft 로그아웃 엔드포인트 호출 (선택)"
    
    - id: "AUTH004"
      name: "토큰 상태 확인"
      description: "현재 토큰 유효성 및 권한 확인"
      priority: "중요"
      status: "미구현"
      output:
        - type: "JSON"
          schema:
            is_valid: "boolean"
            expires_at: "datetime"
            scopes: ["string"]
            user_email: "string"

  mail_collection_features:
    - id: "MAIL001"
      name: "메일 목록 수집"
      description: "인증된 사용자의 메일 목록 가져오기"
      priority: "필수"
      status: "개발중"
      dependencies: ["AUTH001"]
      api_endpoint: "GET /me/messages"
      parameters:
        - "$top": "페이지당 메일 수"
        - "$select": "필요한 필드만 선택"
        - "$orderby": "정렬 기준"
      
    - id: "MAIL002"
      name: "메일 폴더별 수집"
      description: "특정 메일 폴더의 메일 수집"
      priority: "중요"
      status: "미구현"
      dependencies: ["AUTH001", "MAIL001"]
      api_endpoint: "GET /me/mailFolders/{folder-id}/messages"
      
    - id: "MAIL003"
      name: "증분 동기화"
      description: "Delta Query를 사용한 변경사항만 동기화"
      priority: "필수"
      status: "미구현"
      dependencies: ["AUTH001"]
      api_endpoint: "GET /me/messages/delta"
      processing_steps:
        - "초기 동기화 시 전체 메일 수집"
        - "deltaLink 저장"
        - "다음 동기화 시 deltaLink 사용하여 변경사항만 수집"
        - "새 deltaLink로 업데이트"

# 5. 비기능 요구사항
non_functional_requirements:
  security:
    authentication:
      - "PKCE (Proof Key for Code Exchange) 적용"
      - "State 파라미터로 CSRF 방지"
      - "토큰 암호화 저장"
      - "HTTPS 전용 통신"
    
    token_management:
      - "Access Token 만료 시간: 1시간"
      - "Refresh Token 만료 시간: 90일"
      - "토큰 자동 갱신: 만료 5분 전"
    
    permissions:
      - "최소 권한 원칙 적용"
      - "필요한 Graph API 권한만 요청"
      - "사용자별 권한 격리"
  
  performance:
    - "동시 인증 처리: 100 사용자/분"
    - "메일 수집 속도: 1000 메일/분"
    - "토큰 갱신 시간: < 1초"
  
  availability:
    - "토큰 갱신 실패 시 재시도 로직"
    - "Graph API 장애 시 백오프 전략"
    - "로컬 캐싱으로 일시적 오프라인 지원"

# 6. API 엔드포인트
api_endpoints:
  authentication:
    - path: "/auth/login"
      method: "GET"
      description: "Microsoft 로그인 페이지로 리다이렉트"
      
    - path: "/auth/callback"
      method: "GET"
      description: "OAuth 콜백 처리 및 토큰 교환"
      parameters:
        - name: "code"
          type: "string"
          required: true
        - name: "state"
          type: "string"
          required: true
    
    - path: "/auth/refresh"
      method: "POST"
      description: "토큰 갱신"
      
    - path: "/auth/logout"
      method: "POST"
      description: "로그아웃 처리"
    
    - path: "/auth/status"
      method: "GET"
      description: "현재 인증 상태 확인"
  
  mail_operations:
    - path: "/mail/sync"
      method: "POST"
      description: "메일 동기화 시작"
      
    - path: "/mail/folders"
      method: "GET"
      description: "메일 폴더 목록 조회"
      
    - path: "/mail/messages"
      method: "GET"
      description: "수집된 메일 목록 조회"

# 7. 데이터 모델
data_models:
  user_session:
    fields:
      - user_id: "string (primary key)"
      - email: "string"
      - display_name: "string"
      - access_token: "encrypted string"
      - refresh_token: "encrypted string"
      - token_expires_at: "datetime"
      - delta_link: "string"
      - last_sync: "datetime"
  
  mail_message:
    fields:
      - message_id: "string (primary key)"
      - user_id: "string (foreign key)"
      - subject: "string"
      - from_address: "string"
      - to_addresses: "array"
      - received_datetime: "datetime"
      - folder_id: "string"
      - is_read: "boolean"
      - has_attachments: "boolean"

# 8. 에러 처리
error_handling:
  authentication_errors:
    - code: "AUTH_FAILED"
      description: "인증 실패"
      action: "로그인 페이지로 리다이렉트"
    
    - code: "TOKEN_EXPIRED"
      description: "토큰 만료"
      action: "자동 갱신 시도"
    
    - code: "INVALID_SCOPE"
      description: "권한 부족"
      action: "필요 권한 재요청"
  
  api_errors:
    - code: "RATE_LIMIT"
      description: "API 호출 한도 초과"
      action: "지수 백오프로 재시도"
    
    - code: "GRAPH_API_ERROR"
      description: "Graph API 오류"
      action: "에러 로깅 및 사용자 알림"

# 9. 모니터링
monitoring:
  metrics:
    - "인증 성공/실패율"
    - "토큰 갱신 빈도"
    - "API 호출 수/분"
    - "동기화된 메일 수"
    - "평균 응답 시간"
  
  alerts:
    - "인증 실패율 > 10%"
    - "토큰 갱신 실패"
    - "API 할당량 80% 도달"
    - "동기화 지연 > 5분"
